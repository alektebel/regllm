{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este SQL que calcula la PD:\n```sql\nSELECT cliente_id,\n       COUNT(CASE WHEN default_flag = 1 THEN 1 END) / COUNT(*) as pd\nFROM historico_clientes\nWHERE fecha >= DATEADD(year, -5, GETDATE())\nGROUP BY cliente_id;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Ventana temporal insuficiente**: El código usa 5 años, pero EBA/GL/2017/16 párrafo 74 requiere mínimo 5 años para PD y recomienda ciclo económico completo (7-10 años).\n2. ❌ **Definición de default incompleta**: Solo usa default_flag=1 sin verificar los 90 días de mora ni unlikely to pay según CRR Art. 178.\n3. ❌ **Sin ajuste al ciclo**: Falta ajuste Through-The-Cycle (TTC) o Point-In-Time (PIT) según metodología.\n4. ⚠️ **Sin margen de conservadurismo**: EBA/GL/2017/16 párrafo 122 requiere añadir margen cuando hay incertidumbre.\n\n**Código corregido:**\n```sql\nSELECT cliente_id,\n       (COUNT(CASE WHEN default_90d = 1 OR unlikely_to_pay = 1 THEN 1 END) / NULLIF(COUNT(*), 0)) \n       * (1 + margin_conservadurismo) as pd_ajustada\nFROM historico_clientes\nWHERE fecha >= DATEADD(year, -7, GETDATE())\nGROUP BY cliente_id;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este cálculo de LGD:\n```sql\nSELECT segmento,\n       AVG(1 - recuperacion_total / exposicion_default) as lgd\nFROM defaults_historicos\nGROUP BY segmento;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin descuento temporal**: EBA/GL/2017/16 párrafo 156 exige descontar flujos de recuperación a valor presente usando tasa apropiada.\n2. ❌ **Costes no incluidos**: Falta incluir costes directos e indirectos de recuperación (párrafo 158).\n3. ❌ **Sin downturn LGD**: CRR Art. 181(1)(b) requiere LGD en condiciones de recesión, no solo promedio histórico.\n4. ⚠️ **Workout period**: No se verifica que los defaults estén completamente resueltos.\n\n**Código corregido:**\n```sql\nSELECT segmento,\n       AVG(1 - (recuperacion_descontada - costes_directos - costes_indirectos) \n           / NULLIF(exposicion_default, 0)) as lgd_workout,\n       MAX(lgd_downturn_factor) as lgd_downturn\nFROM defaults_historicos\nWHERE workout_completo = 1\nGROUP BY segmento;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este SQL de EAD para líneas de crédito:\n```sql\nSELECT contrato_id,\n       saldo_dispuesto + (limite_credito - saldo_dispuesto) * 0.75 as ead\nFROM lineas_credito;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **CCF fijo incorrecto**: El factor 0.75 es arbitrario. EBA/GL/2017/16 párrafo 189 requiere estimar CCF con datos históricos propios.\n2. ❌ **Sin horizonte de 12 meses**: El CCF debe reflejar disposiciones adicionales en los 12 meses previos al default (párrafo 185).\n3. ❌ **Sin segmentación**: CCF debe estimarse por tipo de producto y perfil de riesgo.\n4. ⚠️ **Floor regulatorio**: CRR establece floors para CCF según tipo de exposición.\n\n**Código corregido:**\n```sql\nSELECT c.contrato_id,\n       c.saldo_dispuesto + \n       (c.limite_credito - c.saldo_dispuesto) * \n       GREATEST(ccf.ccf_estimado, ccf.ccf_floor_regulatorio) as ead\nFROM lineas_credito c\nJOIN ccf_por_segmento ccf ON c.segmento = ccf.segmento\nWHERE ccf.ventana_observacion = '12M';\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa esta query de calibración de PD:\n```sql\nSELECT rating_bucket,\n       SUM(default_1y) / COUNT(*) as tasa_default_observada\nFROM portfolio_historico\nGROUP BY rating_bucket\nORDER BY rating_bucket;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin long-run average**: EBA/GL/2017/16 párrafo 79 requiere PD como media de largo plazo, no tasa puntual.\n2. ❌ **Falta monotonicidad**: No se verifica que PD sea creciente con el rating (párrafo 99).\n3. ❌ **Sin test de discriminación**: Falta calcular Gini/AUC para validar poder discriminatorio.\n4. ⚠️ **Bins pequeños**: No hay control de mínimo de observaciones por bucket.\n\n**Código corregido:**\n```sql\nWITH tasas_anuales AS (\n    SELECT rating_bucket, año,\n           SUM(default_1y)*1.0 / COUNT(*) as dr_anual,\n           COUNT(*) as n_obs\n    FROM portfolio_historico\n    GROUP BY rating_bucket, año\n)\nSELECT rating_bucket,\n       AVG(dr_anual) as pd_long_run,\n       MIN(n_obs) as min_observaciones,\n       COUNT(DISTINCT año) as años_datos\nFROM tasas_anuales\nGROUP BY rating_bucket\nHAVING MIN(n_obs) >= 20\nORDER BY pd_long_run;  -- Verificar monotonicidad\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este cálculo de provisiones IFRS9:\n```sql\nSELECT cuenta_id,\n       CASE stage\n           WHEN 1 THEN ead * pd_12m * lgd\n           WHEN 2 THEN ead * pd_lifetime * lgd\n           WHEN 3 THEN ead * lgd\n       END as provision_ecl\nFROM cartera_creditos;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin descuento temporal**: IFRS 9 párrafo 5.5.17 requiere descontar ECL a valor presente usando TIE original.\n2. ❌ **Stage 3 incorrecto**: Para Stage 3, LGD debe ser específica del activo deteriorado, no genérica.\n3. ❌ **Sin escenarios macro**: IFRS 9 B5.5.42 exige ponderar escenarios macroeconómicos (base, adverso, favorable).\n4. ⚠️ **EAD sin CCF**: Para compromisos, EAD debe incluir factor de conversión.\n\n**Código corregido:**\n```sql\nSELECT cuenta_id,\n       CASE stage\n           WHEN 1 THEN ead * pd_12m * lgd / POWER(1 + tie_original, plazo_residual)\n           WHEN 2 THEN SUM(ead_t * pd_marginal_t * lgd_t / POWER(1 + tie_original, t))\n           WHEN 3 THEN ead * lgd_especifica / POWER(1 + tie_original, plazo_recuperacion)\n       END * escenario_ponderado as provision_ecl\nFROM cartera_creditos\nCROSS JOIN escenarios_macro;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este SQL de backtesting de PD:\n```sql\nSELECT rating,\n       COUNT(CASE WHEN real_default = 1 THEN 1 END) as defaults_reales,\n       SUM(pd_estimada) as defaults_esperados\nFROM backtesting_portfolio\nGROUP BY rating;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin test estadístico**: EBA/GL/2017/16 párrafo 231 requiere test binomial o chi-cuadrado para evaluar desviaciones.\n2. ❌ **Falta intervalo de confianza**: Debe calcularse IC al 95% para determinar si desviación es significativa.\n3. ❌ **Sin traffic light approach**: Supervisores usan semáforo (verde/amarillo/rojo) según severidad.\n4. ⚠️ **Agregación temporal**: Debe analizarse por año para detectar tendencias.\n\n**Código corregido:**\n```sql\nWITH bt_stats AS (\n    SELECT rating, año,\n           COUNT(*) as n,\n           SUM(CASE WHEN real_default = 1 THEN 1 ELSE 0 END) as d_real,\n           SUM(pd_estimada) as d_esperado,\n           AVG(pd_estimada) as pd_media\n    FROM backtesting_portfolio\n    GROUP BY rating, año\n)\nSELECT rating, año, n, d_real, d_esperado,\n       -- Test binomial aproximado\n       (d_real - d_esperado) / SQRT(n * pd_media * (1 - pd_media)) as z_score,\n       CASE \n           WHEN ABS(z_score) < 1.96 THEN 'VERDE'\n           WHEN ABS(z_score) < 2.58 THEN 'AMARILLO'\n           ELSE 'ROJO'\n       END as semaforo\nFROM bt_stats;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza esta definición de default:\n```sql\nSELECT cliente_id,\n       CASE WHEN dias_mora > 90 THEN 1 ELSE 0 END as default_flag\nFROM clientes;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Definición incompleta**: CRR Art. 178 requiere TAMBIÉN unlikely to pay (UTP), no solo 90 días mora.\n2. ❌ **Sin materialidad**: Debe aplicarse umbral de materialidad (1% o 100€ para retail, según EBA/GL/2016/07).\n3. ❌ **Sin contagio**: Falta propagación del default a operaciones relacionadas del mismo cliente.\n4. ❌ **Sin cura**: No hay lógica de período de cura (mínimo 3 meses según EBA).\n\n**Código corregido:**\n```sql\nSELECT c.cliente_id,\n       CASE \n           WHEN c.dias_mora > 90 \n                AND c.importe_vencido > GREATEST(c.exposicion * 0.01, 100)\n           THEN 1\n           WHEN c.unlikely_to_pay = 1 THEN 1\n           WHEN c.reestructurado_distress = 1 THEN 1\n           WHEN c.cliente_id IN (SELECT cliente_id FROM defaults_contagio) THEN 1\n           ELSE 0\n       END as default_flag,\n       CASE WHEN dias_desde_cura >= 90 THEN 1 ELSE 0 END as curado\nFROM clientes c;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este cálculo de RWA:\n```sql\nSELECT SUM(ead * pd * lgd * 12.5 * 0.08) as rwa\nFROM cartera_irb;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Fórmula IRB incorrecta**: CRR Art. 153 usa función de correlación y distribución normal, no multiplicación simple.\n2. ❌ **Sin correlación de activos**: Falta R = 0.12*(1-EXP(-50*PD))/(1-EXP(-50)) + 0.24*(1-(1-EXP(-50*PD))/(1-EXP(-50))).\n3. ❌ **Sin ajuste por madurez**: Falta factor de ajuste por vencimiento M según Art. 162.\n4. ❌ **Factor 12.5 mal aplicado**: Es 1/0.08 = 12.5, pero la fórmula es K * 12.5 * EAD.\n\n**Código corregido:**\n```sql\nWITH params AS (\n    SELECT ead, pd, lgd, m as madurez,\n           0.12 * (1-EXP(-50*pd))/(1-EXP(-50)) + 0.24 * (1-(1-EXP(-50*pd))/(1-EXP(-50))) as R,\n           (1 + (m-2.5) * b) / (1 - 1.5*b) as ajuste_madurez\n    FROM cartera_irb\n)\nSELECT SUM(\n    (lgd * NORMDIST_INV(0.999) * SQRT(R/(1-R)) + lgd * NORMDIST_INV(pd) * SQRT(1/(1-R)) - pd*lgd)\n    * ajuste_madurez * 12.5 * ead\n) as rwa\nFROM params;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este SQL de segmentación para modelos PD:\n```sql\nSELECT CASE\n           WHEN ingresos > 1000000 THEN 'CORPORATE'\n           ELSE 'RETAIL'\n       END as segmento\nFROM clientes;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Criterio único insuficiente**: CRR Art. 147 define categorías por tipo de contraparte, no solo ingresos.\n2. ❌ **Umbral incorrecto**: SME es ventas anuales < 50M€ (Art. 501), corporate > 50M€.\n3. ❌ **Sin subcategorías retail**: Debe distinguir hipotecas, renovables, otros retail (Art. 154).\n4. ⚠️ **Falta granularidad**: EBA requiere pools homogéneos por características de riesgo.\n\n**Código corregido:**\n```sql\nSELECT cliente_id,\n       CASE\n           WHEN tipo_contraparte = 'SOBERANO' THEN 'SOBERANOS'\n           WHEN tipo_contraparte = 'INSTITUCION' THEN 'INSTITUCIONES'\n           WHEN ventas_anuales >= 50000000 THEN 'CORPORATE'\n           WHEN ventas_anuales < 50000000 AND tipo = 'EMPRESA' THEN 'SME_CORPORATE'\n           WHEN garantia_hipotecaria = 1 THEN 'RETAIL_HIPOTECAS'\n           WHEN tipo_producto = 'RENOVABLE' THEN 'RETAIL_RENOVABLE_QRRE'\n           WHEN exposicion < 1000000 AND granularidad_ok = 1 THEN 'RETAIL_OTROS'\n           ELSE 'SME_RETAIL'\n       END as segmento_irb\nFROM clientes;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este cálculo de matriz de transición:\n```sql\nSELECT rating_inicio, rating_fin,\n       COUNT(*) as transiciones\nFROM historico_ratings\nGROUP BY rating_inicio, rating_fin;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin normalización**: Debe expresarse como probabilidad (%), no conteos absolutos.\n2. ❌ **Sin horizonte temporal**: EBA requiere matrices a 1 año, debe filtrarse por período.\n3. ❌ **Falta estado absorbente**: Default debe ser estado absorbente (no transiciones desde default).\n4. ⚠️ **Sin cohort vs duration**: Debe especificarse método de estimación.\n\n**Código corregido:**\n```sql\nWITH transiciones AS (\n    SELECT rating_inicio, rating_fin,\n           COUNT(*) as n_trans\n    FROM historico_ratings\n    WHERE DATEDIFF(month, fecha_inicio, fecha_fin) = 12\n      AND rating_inicio != 'DEFAULT'  -- Estado absorbente\n    GROUP BY rating_inicio, rating_fin\n),\ntotales AS (\n    SELECT rating_inicio, SUM(n_trans) as total\n    FROM transiciones\n    GROUP BY rating_inicio\n)\nSELECT t.rating_inicio, t.rating_fin,\n       t.n_trans * 100.0 / NULLIF(tot.total, 0) as prob_transicion_pct\nFROM transiciones t\nJOIN totales tot ON t.rating_inicio = tot.rating_inicio\nORDER BY t.rating_inicio, t.rating_fin;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este SQL de stress testing de PD:\n```sql\nSELECT cliente_id,\n       pd_base * 1.5 as pd_stress\nFROM cartera;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Factor arbitrario**: El multiplicador 1.5 no está basado en análisis macroeconómico.\n2. ❌ **Sin modelo satélite**: EBA/GL/2018/04 requiere vincular PD a variables macro (PIB, desempleo).\n3. ❌ **Sin escenarios EBA**: Debe usarse escenario adverso oficial de EBA stress test.\n4. ⚠️ **Sin cap**: PD estresada no puede superar 100%.\n\n**Código corregido:**\n```sql\nWITH escenario_adverso AS (\n    SELECT sector,\n           pib_shock, desempleo_shock, tipos_shock\n    FROM escenarios_eba\n    WHERE tipo = 'ADVERSO' AND año = 2024\n)\nSELECT c.cliente_id,\n       LEAST(1.0,\n           c.pd_base * EXP(\n               m.beta_pib * e.pib_shock +\n               m.beta_desempleo * e.desempleo_shock +\n               m.beta_tipos * e.tipos_shock\n           )\n       ) as pd_stress\nFROM cartera c\nJOIN modelos_satelite m ON c.segmento = m.segmento\nJOIN escenario_adverso e ON c.sector = e.sector;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa esta validación de poder discriminatorio:\n```sql\nSELECT \n    (SELECT COUNT(*) FROM pares WHERE score_default > score_no_default) /\n    (SELECT COUNT(*) FROM pares) as gini\nFROM dual;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Fórmula Gini incorrecta**: Gini = 2*AUC - 1, no ratio de pares concordantes.\n2. ❌ **Sin empates**: Debe considerar pares empatados (0.5 de crédito).\n3. ❌ **Sin intervalo confianza**: EBA requiere bootstrap o DeLong para IC.\n4. ⚠️ **Umbral mínimo**: Gini > 0.40 generalmente aceptable, < 0.30 problemático.\n\n**Código corregido:**\n```sql\nWITH pares_ordenados AS (\n    SELECT \n        SUM(CASE \n            WHEN d.score > nd.score THEN 1.0\n            WHEN d.score = nd.score THEN 0.5\n            ELSE 0.0\n        END) as concordantes,\n        COUNT(*) as total_pares\n    FROM defaults d\n    CROSS JOIN no_defaults nd\n),\nauc_calc AS (\n    SELECT concordantes / NULLIF(total_pares, 0) as auc\n    FROM pares_ordenados\n)\nSELECT \n    auc,\n    2 * auc - 1 as gini,\n    CASE \n        WHEN 2*auc-1 >= 0.50 THEN 'EXCELENTE'\n        WHEN 2*auc-1 >= 0.40 THEN 'BUENO'\n        WHEN 2*auc-1 >= 0.30 THEN 'ACEPTABLE'\n        ELSE 'INSUFICIENTE'\n    END as clasificacion\nFROM auc_calc;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este cálculo de capital por riesgo de crédito:\n```sql\nSELECT SUM(rwa * 0.08) as capital_requerido\nFROM exposiciones_irb;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ⚠️ **Solo Pilar 1**: El 8% es mínimo regulatorio, falta buffer de conservación (2.5%), contracíclico y G-SIB/O-SII.\n2. ❌ **Sin Pilar 2**: Falta P2R (Pillar 2 Requirement) específico del supervisor.\n3. ❌ **Sin output floor**: Basel III final (CRR3) introduce floor del 72.5% vs método estándar.\n4. ⚠️ **Sin MREL/TLAC**: Entidades sistémicas tienen requerimientos adicionales.\n\n**Código corregido:**\n```sql\nWITH rwa_total AS (SELECT SUM(rwa) as rwa FROM exposiciones_irb),\n     floor_calc AS (\n         SELECT SUM(rwa_estandar) * 0.725 as rwa_floor \n         FROM exposiciones_estandar\n     ),\n     buffers AS (\n         SELECT 0.025 as conservacion, 0.01 as contraciclico, 0.02 as gsib\n     )\nSELECT \n    GREATEST(r.rwa, f.rwa_floor) as rwa_aplicable,\n    GREATEST(r.rwa, f.rwa_floor) * (0.08 + b.conservacion + b.contraciclico + b.gsib) as capital_total,\n    GREATEST(r.rwa, f.rwa_floor) * 0.08 as pilar1,\n    GREATEST(r.rwa, f.rwa_floor) * p2r.ratio as pilar2\nFROM rwa_total r, floor_calc f, buffers b\nJOIN pilar2_requerimientos p2r ON 1=1;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este cálculo de pérdida esperada:\n```sql\nSELECT SUM(ead * pd * lgd) as expected_loss\nFROM cartera;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ✅ **Fórmula correcta**: EL = EAD × PD × LGD es la fórmula estándar.\n2. ⚠️ **Sin comparación con provisiones**: CRR Art. 159 compara EL con provisiones para ajuste de capital.\n3. ⚠️ **Sin desglose**: Debe separarse por categoría de exposición y estado (performing/non-performing).\n4. ⚠️ **Consistencia parámetros**: Verificar que PD y LGD sean consistentes (TTC vs PIT).\n\n**Código mejorado:**\n```sql\nSELECT \n    segmento,\n    estado,\n    SUM(ead * pd * lgd) as expected_loss,\n    SUM(provision_ifrs9) as provisiones,\n    SUM(ead * pd * lgd) - SUM(provision_ifrs9) as shortfall,\n    CASE \n        WHEN SUM(ead * pd * lgd) > SUM(provision_ifrs9) \n        THEN 'DEDUCIR_CET1'  -- Art. 159(1)\n        ELSE 'AÑADIR_T2'     -- Art. 159(2), máx 0.6% RWA\n    END as tratamiento_capital\nFROM cartera\nGROUP BY segmento, estado;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este SQL de cure rate:\n```sql\nSELECT COUNT(CASE WHEN curado = 1 THEN 1 END) / COUNT(*) as cure_rate\nFROM defaults_historicos;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin período de observación**: EBA requiere período mínimo de cura (típicamente 12 meses sin reincidencia).\n2. ❌ **Sin probation period**: Debe verificarse que cliente permanece sano tras cura (mínimo 3 meses).\n3. ❌ **Redefault no considerado**: Debe medir tasa de re-default post-cura.\n4. ⚠️ **Impacto en LGD**: Cure rate afecta LGD workout vs LGD cure.\n\n**Código corregido:**\n```sql\nWITH curas AS (\n    SELECT d.default_id,\n           d.fecha_default,\n           c.fecha_cura,\n           DATEDIFF(month, c.fecha_cura, GETDATE()) as meses_desde_cura,\n           CASE WHEN rd.redefault_id IS NOT NULL THEN 1 ELSE 0 END as redefault\n    FROM defaults_historicos d\n    LEFT JOIN curas_registradas c ON d.default_id = c.default_id\n    LEFT JOIN redefaults rd ON c.cura_id = rd.cura_origen_id\n)\nSELECT \n    COUNT(CASE WHEN fecha_cura IS NOT NULL AND meses_desde_cura >= 12 THEN 1 END) \n        * 1.0 / NULLIF(COUNT(*), 0) as cure_rate_estable,\n    AVG(CASE WHEN redefault = 1 THEN 1.0 ELSE 0.0 END) as tasa_redefault,\n    1 - AVG(CASE WHEN redefault = 1 THEN 1.0 ELSE 0.0 END) as cure_rate_neto\nFROM curas\nWHERE fecha_default <= DATEADD(year, -2, GETDATE());  -- Cohortes maduras\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este SQL de concentración sectorial:\n```sql\nSELECT sector, SUM(exposicion) as exposicion_total\nFROM cartera\nGROUP BY sector\nORDER BY exposicion_total DESC;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ⚠️ **Sin límites de concentración**: CRR Art. 395 limita grandes exposiciones al 25% del capital.\n2. ❌ **Sin HHI**: Debe calcularse índice Herfindahl-Hirschman para medir concentración.\n3. ❌ **Falta correlación intra-sector**: Pilar 2 requiere add-on por concentración.\n4. ⚠️ **Sin connected parties**: Grupos conectados deben agregarse.\n\n**Código mejorado:**\n```sql\nWITH exposiciones AS (\n    SELECT sector, SUM(exposicion) as exp_sector\n    FROM cartera\n    GROUP BY sector\n),\ntotales AS (\n    SELECT SUM(exp_sector) as exp_total FROM exposiciones\n),\ncapital AS (\n    SELECT cet1 FROM ratios_capital WHERE fecha = (SELECT MAX(fecha) FROM ratios_capital)\n)\nSELECT \n    e.sector,\n    e.exp_sector,\n    e.exp_sector * 100.0 / t.exp_total as pct_cartera,\n    e.exp_sector / c.cet1 as pct_capital,\n    CASE WHEN e.exp_sector / c.cet1 > 0.25 THEN 'EXCESO_LIMITE' ELSE 'OK' END as limite_25pct,\n    POWER(e.exp_sector / t.exp_total, 2) as hhi_componente\nFROM exposiciones e, totales t, capital c\nORDER BY e.exp_sector DESC;\n\n-- HHI total\nSELECT SUM(POWER(exp_sector / (SELECT SUM(exp_sector) FROM exposiciones), 2)) as hhi_total\nFROM exposiciones;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este cálculo de margen de conservadurismo:\n```sql\nSELECT pd_estimada * 1.10 as pd_con_margen\nFROM modelos_pd;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Margen arbitrario**: 10% no está justificado por análisis de incertidumbre.\n2. ❌ **Sin componentes MoC**: EBA/GL/2017/16 párrafo 122-124 requiere MoC por: (A) datos, (B) métodos, (C) modelo.\n3. ❌ **Sin proporcionalidad**: MoC debe ser mayor donde hay más incertidumbre.\n4. ⚠️ **Documentación**: Debe justificarse cuantitativamente.\n\n**Código corregido:**\n```sql\nWITH incertidumbres AS (\n    SELECT modelo_id,\n           pd_estimada,\n           -- Componente A: Calidad de datos\n           CASE \n               WHEN n_observaciones < 100 THEN 0.05\n               WHEN n_observaciones < 500 THEN 0.03\n               ELSE 0.01\n           END as moc_datos,\n           -- Componente B: Metodología\n           CASE \n               WHEN metodo = 'EXPERT' THEN 0.05\n               WHEN metodo = 'STATISTICAL' THEN 0.02\n               ELSE 0.03\n           END as moc_metodo,\n           -- Componente C: Error de estimación\n           error_estandar / NULLIF(pd_estimada, 0) as moc_estimacion\n    FROM modelos_pd\n)\nSELECT modelo_id,\n       pd_estimada,\n       pd_estimada * (1 + moc_datos + moc_metodo + COALESCE(moc_estimacion, 0.02)) as pd_con_moc,\n       moc_datos + moc_metodo + COALESCE(moc_estimacion, 0.02) as moc_total_pct\nFROM incertidumbres;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este SQL de cálculo de exposiciones off-balance:\n```sql\nSELECT contrato_id, limite - dispuesto as off_balance\nFROM lineas_credito;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ✅ **Cálculo base correcto**: Off-balance = Límite - Dispuesto.\n2. ❌ **Sin CCF para EAD**: CRR Art. 166 requiere aplicar factor de conversión.\n3. ❌ **Sin distinción por tipo**: CCF varía según compromiso (revocable/irrevocable).\n4. ⚠️ **Compromisos revocables**: Antes tenían CCF=0%, ahora 10% bajo Basel III final.\n\n**Código corregido:**\n```sql\nSELECT \n    c.contrato_id,\n    c.limite - c.dispuesto as off_balance,\n    CASE c.tipo_compromiso\n        WHEN 'IRREVOCABLE' THEN \n            CASE c.producto\n                WHEN 'LINEA_LIQUIDEZ' THEN 1.00  -- 100%\n                WHEN 'COMERCIO_EXTERIOR' THEN 0.50\n                ELSE ccf.ccf_estimado\n            END\n        WHEN 'REVOCABLE_INCONDICIONAL' THEN 0.10  -- Basel III final\n        ELSE 0.40  -- Otros\n    END as ccf,\n    c.dispuesto + (c.limite - c.dispuesto) * ccf as ead_total\nFROM lineas_credito c\nLEFT JOIN ccf_modelos ccf ON c.segmento = ccf.segmento;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Analiza este SQL de vintage analysis:\n```sql\nSELECT fecha_originacion, COUNT(*) as num_creditos\nFROM cartera\nGROUP BY fecha_originacion;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ❌ **Sin tasas de default**: Vintage analysis requiere medir default rates por cohorte.\n2. ❌ **Sin maduración**: Debe mostrar evolución temporal de cada vintage.\n3. ❌ **Sin normalización**: Tasas deben ser acumuladas y/o marginales.\n4. ⚠️ **Granularidad**: Típicamente por trimestre o año de originación.\n\n**Código corregido:**\n```sql\nWITH vintage_data AS (\n    SELECT \n        DATE_TRUNC('quarter', fecha_originacion) as vintage,\n        DATEDIFF(month, fecha_originacion, COALESCE(fecha_default, GETDATE())) as mob,\n        CASE WHEN default_flag = 1 THEN 1 ELSE 0 END as default_ind,\n        1 as credito\n    FROM cartera\n)\nSELECT \n    vintage,\n    mob as months_on_books,\n    COUNT(*) as creditos_originados,\n    SUM(default_ind) as defaults_acumulados,\n    SUM(default_ind) * 100.0 / COUNT(*) as tasa_default_acumulada,\n    SUM(default_ind) - LAG(SUM(default_ind)) OVER (PARTITION BY vintage ORDER BY mob) \n        as defaults_marginales\nFROM vintage_data\nWHERE mob BETWEEN 0 AND 36  -- Primeros 3 años\nGROUP BY vintage, mob\nORDER BY vintage, mob;\n```"}]}
{"messages": [{"role": "system", "content": "Eres un experto en riesgo de crédito que revisa código SQL para verificar su conformidad con las metodologías de estimación de parámetros IRB (PD, LGD, EAD) según las directrices EBA/GL/2017/16 y normativa de Banco de España."}, {"role": "user", "content": "Revisa este SQL de migración entre stages IFRS9:\n```sql\nSELECT old_stage, new_stage, COUNT(*) as migraciones\nFROM stage_changes\nGROUP BY old_stage, new_stage;\n```"}, {"role": "assistant", "content": "**ANÁLISIS DE CONFORMIDAD METODOLÓGICA**\n\n**Hallazgos:**\n1. ⚠️ **Sin importe**: Debe ponderar por exposición, no solo contar operaciones.\n2. ❌ **Sin drivers de migración**: IFRS 9 B5.5.17 requiere analizar causas del SICR.\n3. ❌ **Sin temporal**: Debe segmentarse por período para detectar tendencias.\n4. ⚠️ **Sin impacto P&L**: Migración Stage 1→2 aumenta provisiones significativamente.\n\n**Código corregido:**\n```sql\nWITH migraciones AS (\n    SELECT \n        sc.periodo,\n        sc.old_stage,\n        sc.new_stage,\n        sc.operacion_id,\n        c.ead,\n        c.provision_old,\n        c.provision_new,\n        sc.driver_migracion  -- 30dpd, watch_list, sector_deterioro, etc.\n    FROM stage_changes sc\n    JOIN cartera c ON sc.operacion_id = c.operacion_id\n)\nSELECT \n    periodo,\n    old_stage,\n    new_stage,\n    COUNT(*) as num_operaciones,\n    SUM(ead) as exposicion_migrada,\n    SUM(provision_new - provision_old) as impacto_provisiones,\n    driver_migracion,\n    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (PARTITION BY periodo, old_stage) as pct_migracion\nFROM migraciones\nGROUP BY periodo, old_stage, new_stage, driver_migracion\nORDER BY periodo, old_stage, new_stage;\n```"}]}
